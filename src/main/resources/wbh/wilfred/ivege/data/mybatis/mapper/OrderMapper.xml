<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="wbh.wilfred.ivege.data.mybatis.mapper.OrderMapper">
    <resultMap id="orderMap" type="Order">
        <id property="id" column="id"/>
        <result property="name" column="name"/>
        <result property="phone" column="phone"/>
        <result property="address" column="address"/>
        <result property="originalTotal" column="original_total"/>
        <result property="total" column="total"/>
        <result property="createTime" column="create_time"/>
        <result property="deliverTime" column="deliver_time"/>
        <result property="completeTime" column="complete_time"/>
        <result property="status" column="status"/>
        <association property="discount" javaType="Discount"
                     columnPrefix="d_"
                     resultMap="wbh.wilfred.ivege.data.mybatis.mapper.DiscountMapper.discountMap">
        </association>
        <collection property="items" ofType="OrderItem" column="id"
                    select="wbh.wilfred.ivege.data.mybatis.mapper.OrderItemMapper.getOrderItemByOrderId"/>
    </resultMap>
    <select id="getOrderById" resultMap="orderMap">
        SELECT * FROM `order` WHERE id = #{id} LIMIT 1
    </select>
    <insert id="addOrder" parameterType="Order" useGeneratedKeys="true"
            keyProperty="id">
        INSERT INTO `order` (address, `name`, phone, originalTotal,
        creation_time, delivery_time, `status`)
        VALUES (#{address}, #{name}, #{phone}, #{originalTotal}, now(),
        #{deliverTime}, #{status})
    </insert>
    <select id="getOrders" resultMap="orderMap">
        SELECT * FROM `order`
        <where>
            <if test="address != null">
                address = #{address}
            </if>
            <if test="name != null">
                AND name = #{name}
            </if>
            <if test="phone != null">
                AND phone = #{phone}
            </if>
            <if test="minTotal != null">
                AND originalTotal >= #{minTotal}
            </if>
            <if test="maxTotal != null">
                <![CDATA[
                AND originalTotal <= #{maxTotal}
                ]]>
            </if>
            <if test="startCreateTime != null">
                AND creation_time >= #{startCreateTime}
            </if>
            <if test="endCreateTime != null">
                <![CDATA[
                AND creation_time <= #{endCreateTime}
                ]]>
            </if>
            <if test="startDeliverTime != null">
                AND delivery_time >= #{startDeliverTime}
            </if>
            <if test="endDeliverTime != null">
                <![CDATA[
                AND delivery_time <= #{endDeliverTime}
                ]]>
            </if>
            <if test="startCompleteTime != null">
                AND completion_time >= #{startCompleteTime}
            </if>
            <if test="endCompleteTime != null">
                <![CDATA[
                AND completion_time <= #{endCompleteTime}
                ]]>
            </if>
            <if test="status != null">
                AND status = #{status}
            </if>
        </where>
    </select>
</mapper>